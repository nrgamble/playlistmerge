<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  
  <style>
    @import url('$views/css/buttons.css');
    @import url('$views/css/image.css');
    @import url('$views/css/list.css');
  </style>
  <link rel="stylesheet" href="sp://playlistmerge/css/application.css">
  
  <script src="sp://playlistmerge/js/jquery.js"></script>
  <script src="sp://playlistmerge/js/application.js"></script>
  <script>
    require(['$api/models', '$views/buttons', '$views/utils/dnd', '$views/list#List'], function(models, buttons, dnd, List) {
      
      // TODO: generate all existing playlists
      
      [].forEach.call(document.querySelectorAll('.dropzone'), function(dropBox) {
        dropBox.addEventListener('dragstart', function(e) {
          e.dataTransfer.setData('text/html', this.innerHTML);
          e.dataTransfer.effectAllowed = 'copy';
        }, false);
        dropBox.addEventListener('dragenter', function(e) { this.classList.add('over'); }, false);
        dropBox.addEventListener('dragleave', function(e) { this.classList.remove('over'); }, false)
        dropBox.addEventListener('dragover',  function(e) {
          if (e.preventDefault) { e.preventDefault(); }
          e.dataTransfer.dropEffect = 'copy';
          return false;
        }, false);

        dropBox.addEventListener('drop', function(e) {
          if (e.preventDefault) { e.preventDefault(); }
          
          var $dropzone  = $(this);
          $dropzone.removeClass('over empty');
          
          var $mergelist = $dropzone.parents('.mergelist');
          
          var index = $mergelist.attr('data-index');
          
          var mergelist = mergelistForIndex(index);
          
          var playlistURI = e.dataTransfer.getData('text');
          
          if (mergelist.playlists.indexOf(playlistURI) != -1) {
            return;
          }
          
          var templist;
          
          if ($mergelist.attr('data-uri') == '#') {           
            models.Playlist.createTemporary('mergelist-untitled').done(function (temp) {
              templist = temp;
              
              $mergelist.attr('data-uri', templist.uri);
              
              var add = buttons.Button.withLabel('Add as Playlist');
              add.setIcon('img/add-icon.png');
              $mergelist.find('.add').append(add.node).on('click', function () { mergelistAdd($(this).parents('.mergelist')); });
              
              $mergelist.find('.play').on('click', function () { mergelistPlay($(this).parents('.mergelist')); });
              
              mergelist.name = 'Untitled Mergelist';
            });
          } else {
            templist = models.Playlist.fromURI($mergelist.attr('data-uri'));
          }
          
          templist.load(['tracks']).done(function(temp) {            
            models.Playlist.fromURI(playlistURI).load(['name', 'tracks']).done(function (playlist) {

              playlist.tracks.snapshot(0, 1000).done(function(snapshot) {
                temp.tracks.add(snapshot.toArray());
              });
              
              $mergelist.find('.playlists').append($('<a/>').attr('href', playlist.uri).text(playlist.name));
              mergelist.playlists.push(playlist.uri);
            });
          });
          
          //mergelistSave(index, mergelist);
        }, false);
      });
    
      models.player.load().done(function (player) {
        player.addEventListener('change:track', mergelistChangeTrack);
      });
    
      var playHistory;
      var listHistory;
      models.Playlist.createTemporary('mergelist-playhistory').done(function (history) {
        playHistory = history.uri;
        history.load('tracks').done(function() {
          listHistory = List.forCollection(history.tracks, {
            'fields' : ['star', 'share', 'track', 'artist', 'album'],
            'height' : 'fixed'
          });
          $('.history').append(listHistory.node);
          listHistory.init();
        });
      });
      
      function mergelistPlay($_mergelist) {        
        models.player.load().done(function (player) {
          player.setShuffle(true);
          player.playContext(models.Playlist.fromURI($_mergelist.attr('data-uri')));
        });
      }
      
      function mergelistChangeTrack() {
        var $_mergelist = $('.mergelist');
        models.player.load(['context', 'playing', 'track']).done(function (player) {
          if (player.playing && player.context.uri == $_mergelist.attr('data-uri')) {
            models.Playlist.fromURI(playHistory).load(['tracks']).done(function (history) {
              history.tracks.add(player.track);
              listHistory.refresh();
              $('.sp-list-item').on('dblclick', function (e) {
                e.stopImmediatePropagation();
              });
            });
          }
        });
      }
      
      function mergelistAdd($_mergelist) {
        models.Playlist.create($_mergelist.find('h3').text()).done(function (playlist) {
          playlist.load(['tracks']).done(function (_playlist) {
            models.Playlist.fromURI($_mergelist.attr('data-uri')).load(['tracks']).done(function (templist) {
              templist.tracks.snapshot(0, 1000).done(function(snapshot) {
                _playlist.tracks.add(snapshot.toArray());
              });
            });
          });
        });
      }
      
    });
  </script>
</head>

<body>

  <h1>Playlist Mash</h1>
  
  <p>Add playlists to a mergelist by dragging them from your sidebar</p>
  <hr>
   
  <div class="mergelist clearfix" data-uri="#" data-index="0">
    <div class="header clearfix">
      <img src="sp://playlistmerge/img/playlist.png" width="14" height="14">
      <h3>Mashlist</h3>
      <input type="text">
      <span class="add"></span>
    </div>
    <p><strong>Including playlists:</strong> <span class="playlists"></span></p>
    <div class="controls">
      <div class="dropzone"></div>
      <a class="play"></a>
    </div>
    <div class="tracks">
      <p>Play History</p>
      <div class="history"></div>
    </div>
  </div>

</body>

</html>